# cloud-config
# Update system packages
package_update: true
package_upgrade: true

# Install base packages
packages:
  - qemu-guest-agent
  - wget
  - gpg
  - curl
  - unzip
  - jq
  - net-tools
  - ca-certificates
  - gnupg
  - lsb-release
  - software-properties-common
  - iptables
  - git
  - tmux
  - python3

# Write configuration files
write_files:
  - path: /opt/docker-install.sh
    content: |
      ${indent(6, docker_install_script)}
    owner: root:root
    permissions: '0755'

  - path: /opt/firewall-setup.sh
    content: |
      ${indent(6, firewall_setup_script)}
    owner: root:root
    permissions: '0755'

  - path: /home/ansible/README.md
    content: |
      ${indent(6, readme_content)}
    owner: ansible:ansible
    permissions: '0644'
    defer: true

  - path: /home/ansible/docker-firewall-notes.md
    content: |
      ${indent(6, docker_firewall_docs)}
    owner: ansible:ansible
    permissions: '0644'
    defer: true

# Run commands
runcmd:
  # Enable and start QEMU guest agent first (for IP reporting)
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent

  # Install Docker using the official method
  - /opt/docker-install.sh

  # Setup firewall with Docker compatibility
  - /opt/firewall-setup.sh

# Set timezone
timezone: UTC

# Configure users (ansible user with sudo)
users:
  - default
  - name: ansible
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - >-
        ${ci_ssh_key}
